const model = (() => {
    const episodes = [
        {
            title: "Ginny",
            desc: "Harry tries to talk about the quidditch toys he's building for his future child while Aquila fights to keep him on topic.",
            link: "https://www.youtube.com/embed/HMjmmfO3L1I",
            breakdown: "The idea of Harry Potter in therapy started as a joke, but by fall 2019, we became serious about turning it into a web series. The limited cast and locations required made it perfect for a low budget, and we though the premise had a lot of inherent drama; Harry can be a pretty affable guy, but he’ll do anything to avoid opening up to others. \n\nIn this episode, we focused on that internal conflict. Harry keeps trying wax poetic about Quidditch toys and magic ceilings, but Aquila refuses to let him control their conversation. Frustration slowly builds until Harry cracks and admits, as much to Aquila as to himself, what is truly bothering him. This is the shortest and simplest episode, but it established a basic structure that we drew from in every subsequent episode: Have harry think he’s upset about one thing when it’s really something deeper.",
            bonusContent: [
                {
                    bonusCategory: "Shooting Begins",
                },
                {
                    bonusDesc: "The floating tea pot, cup, and saucer were achieved practically.",
                    links: [
                        "https://www.youtube.com/embed/EoY33IqhZKc",
                    ]
                },
                {
                    bonusDesc: "We shot all the therapy room scenes of this series, comprising over 120 pages, over six days in March 2021. Our total cast and crew never exceeded four people, so everyone had to wear a lot of hats!",
                    classes: ["big"],
                    links: [
                        "../images/ep_1/e01m18_shooting-time.jpg",
                    ],
                },
                {
                    bonusCategory: "Casting"
                },
                {
                    bonusDesc: "Bryce's first audition:",
                    links: [
                        "https://www.youtube.com/embed/5O5wKKLhlyQ",
                    ]
                },
                {
                    bonusCategory: "Disguising Our Apartment",
                },
                {
                    bonusDesc: "We shot the entire series in our apartment.  We built a fake bookshelf to cover a large standing heating unit and a frosted window to hide the view into our kitchen.",
                    classes: ["big"],
                    links: [
                        "../images/ep_1/e01m03_roombefore.jpg",
                        "../images/ep_1/e01m02_set.jpg",
                    ]
                },
                {
                    bonusCategory: "The Pensieve",
                },
                {
                    bonusDesc: "Tyler designed the pensieve and built it out of an old table.",
                    classes: ["bonus-grid"],
                    links: [
                        "../images/ep_1/e01m06_pensieveconcept1.jpg",
                        "../images/ep_1/e01m07_pensieveconcept2.jpg",
                        "../images/ep_1/e01m08_pensievebefore.jpg",
                        "../images/ep_1/e01m09_pensievecomplete.jpg"
                    ]
                },
                {
                    bonusDesc: "LED lights and pearlescent powder provide the magical glow.",
                    links: [
                        "../images/ep_1/e01m10_pensieveglow.jpg",
                    ]
                },
                {
                    bonusDesc: "Finally, some rejected pensieve designs:",
                    classes: ["bonus-grid"],
                    links: [
                        "../images/ep_1/e01m11_pensievealt1.jpg",
                        "../images/ep_1/e01m12_pensievealt2.jpg",
                        "../images/ep_1/e01m13_pensievealt3.jpg",
                    ]
                },
                {
                    bonusCategory: "Designing Episode One",
                },
                {
                    bonusDesc: "Cutler designed Aquila's diploma, which hangs proudly over her couch, as well as her patient intake form.",
                    links: [
                        "../images/ep_1/e01m14_diploma.jpg",
                        "../images/ep_1/e01m15_form.jpg",
                    ],
                },
                {
                    bonusDesc: "Cutler also designed the Witch Weekly magazine cover in the lobby, for which Tyler posed.",
                    links: [
                        "../images/ep_1/e01m17_witchweekly.gif",
                    ]
                },
                {
                    bonusDesc: "We bought Harry a funny owl tie in honor of his late pet.",
                    links: [
                        "../images/ep_1/e01m16_tie.jpg",
                    ],
                },
                {
                    bonusDesc: "Janet brought all her costumes from home!",
                    links: [
                        "../images/ep_1/e01m23.jpg",
                    ]
                },
                {
                    bonusCategory: "The Intro Sequence",
                },
                {
                    bonusDesc: "Determined to hire as few collaborators as possible, Cutler learned After Effects to create the series’ 2D intro sequence. This is Tyler’s initial sketch of their idea:",
                    classes: ["big"],
                    links: [
                        "../images/ep_1/e01m20_introstoryboard.jpg",
                    ],
                },
                {
                    bonusDesc: "Tyler’s regular collaborator George Bjorvik composed the series’s music.",
                    links: [
                        "https://www.youtube.com/embed/GtLQ_ZqY62U",
                        "https://www.youtube.com/embed/nr2OnlWRzXU",
                    ]
                }
            ]
        },
        {
            title: "Molly",
            desc: "Molly didn't knit Harry a sweater for Christmas!  Aquila tries to help Harry figure out why.",
            breakdown: "We brainstormed for a long time on when to set the show before deciding on Ginny’s pregnancy. We realized that the anxiety of impending fatherhood would be an elegant shortcut into many of the themes and relationships we wanted to explore with his character. In the books, Harry has a fascinating diversity of parental relationships. We’ve always loved his relationship with Molly, and since it’s also the healthiest and least complicated, we figured she would be the least daunting to tackle in writing our second episode! It was also a way to set up the Sirius material we knew we wanted to use in Episode 7.\n\nIn the end, though, we didn’t have a ton to say about Molly, so we used this episode as an opportunity to play catch up with various characters from the books. Thus, Episode 2 has the series’s loosest structure, bouncing between vignettes that don’t really connect. To keep the audience’s attention, we tried to think of this episode as a mystery plot:  Why did Molly snub Harry? We included Molly as a character in every story to encourage the audience to search for clues to solve the mystery. The loose structure also provided us an opportunity to introduce exposition about Draco’s dementor hand that would be important for future episodes without calling too much attention to itself.",
            link: "https://www.youtube.com/embed/Ad7j3TdOvPc",
            bonusContent: [

            ]
        },
        {
            title: "Hogwarts",
            desc: "Harry and Ron investigated a crime at Hogwarts, but tensions flared when the visit went south.  Aquila helps Harry put things in perspective.",
            breakdown: "We figured it’s not Harry Potter without a mystery plot. Or Hogwarts. We were fascinated by the idea of Harry revisiting school-aged antics from the perspective of an adult, and we loved the character of Evelyn and her relationship to Harry’s parental anxieties.\n\nOriginally, Ron wasn’t part of this episode. Harry investigated Evelyn by himself, and the “what Harry thinks he’s upset about” of this episode was “Harry is annoyed at Evelyn,” with the epiphany essentially being Harry accepting that his parental anxiety is making him hypocritical. This lack of self-awareness felt like a stretch even for Harry, and his conflict with a random twelve-year-old wasn’t super compelling.\n\nAfter we’d finished writing the other episodes, we felt bad that we hadn’t included enough Ron in the series. We brainstormed places to add him and realized that making him the main supporting character for Episode 3 solved pretty much all of our issues.",
            link: "https://www.youtube.com/embed/EJgX9oUF-8o",
            bonusContent: [

            ]
        },
        {
            title: "Ministry",
            desc: "Harry's in trouble at work thanks to a risky plan to snare a crime boss and he takes it out on Aquila.  Can she keep her cool?",
            breakdown: "We knew from the very beginning that we wanted Episode 4 to end with a fight. In Episode 3, we got Harry to open up and become more comfortable with Aquila so that in Episode 4, they could really let loose and hurt each other’s feelings. The inspiration for this fight was the scene in \"Deathly Hallows\" when Harry yells at Lupin for wanting to abandon his son to join them on the road. Though it’s never made explicit, that’s what’s provoking Harry in this session:  He reminds himself of that which he accused Lupin, and he can’t handle that shame.\n\nThis was the episode where we started feeling like we knew what we were doing. There’s a ton of exposition in this script, but it’s organized in a non-linear structure that (hopefully) feels natural and maintains interest. One of our most useful strategies is teasing and then delaying information—Harry reveals on page 1 that his boss fired him over a crazy idea, and though Aquila asks him about it several times, we don’t reveal what it is until page 11. We’re always trying to create mini-mysteries to keep people engaged.",
            link: "https://www.youtube.com/embed/djs5R4-uCLw",
            bonusContent: [

            ]
        },
        {
            title: "Harry",
            desc: "Aquila isn't sure if Harry will ever come back after their nasty fight.",
            breakdown: "We were finishing Episode 4 and beginning work on the fifth of six sessions we had planned for Harry when we joked about doing a Ginny episode. The idea was too good to pass up. In addition to giving us the opportunity to explore another character and show Ginny’s side of the marriage, having Harry absent from the subsequent episode makes his decision to quit therapy more impactful.\n\nAlthough each script is a single dialogue scene, we meticulously outlined each episode as if we were writing a screenplay with a plot. After brainstorming and determining the backstories and introspective themes, we would plot the order to reveal each piece of information and then map out transitions between the beats. The goal was always to balance dramatic impact with a sense of verisimilitude. In this episode, we were particularly proud of how many threads we tied together: Harry’s venting to Molly instead of Ginny, Ginny’s lunch with her teammate, Ron’s encounter with Harry crying, and Ginny’s childhood experiences all contribute to Aquila’s ultimate advice about vulnerability.",
            link: "https://www.youtube.com/embed/49JkE0ZDG4M",
            bonusContent: [

            ]
        },
        {
            title: "Dumbledore",
            desc: "Aquila finally lets Harry use the pensieve!  Together, they revisit an upsetting encounter with Dumbledore's portrait.",
            breakdown: "We’ve always loved the concept of moving portraits in the books, but we felt their execution was inconsistent, especially in \"Deathly Hallows\" when Dumbledore’s portrait basically acts like a sentient human with fully original ideas. We prefer thinking of moving portraits as super advanced virtual assistant technologies, programmed by their subjects with logic and stock phrases. Even outside of Harry Potter, we’re fascinated with artificial intelligence and the uncanny valley and their potential for dramatic storytelling. Tyler, in particular, has spent years brainstorming scenes with a common theme, where human characters open their hearts to robots before their artificiality betrays them.\n\nDumbledore’s relationship with Harry was the topic we were always most excited and anxious to tackle in this series. In the books, while Harry struggles with Dumbledore’s unpredictable mix of compassion and coldness, and at times resents the man’s secrecy, Harry never fully grasps the extent to which Dumbledore manipulates him. It’s very clear to an adult reader, however, and we think it would become increasingly clear to Harry as he matures and reflects on his teenage experiences. Putting Harry face-to-face with his old mentor was the best way for us to get him to confront those feelings, and to push him into a rawer emotional state than we ever could in the therapy office. To end their conversation with Harry remembering the artificiality of it all seemed like a final knife twist fitting for Dumbledore, the man who never could just give a straight answer.",
            link: "https://www.youtube.com/embed/Eu9uuzv0J8c",
            bonusContent: [

            ]
        },
        {
            title: "James Sirius",
            desc: "Harry Potter is a father!  His new baby forces him to explore his complicated feelings about Sirius Black—plus, Harry finally discovers the identity of the infamous crime boss known as The Jonquil.",
            breakdown: "The substance of this entire series spun out of a single observation:  While \”The Order of the Phoenix\” revolves around Harry’s reaction to witnessing Cedric’s death, the final two books never really portray Harry processing Sirius’s death. One of our goals for this series was to figure out why that is, and Sirius was always planned to be the finale. Completing this episode required us to go deeper into Harry’s psychology than any previous episode.\n\nOriginally, Narcissa’s pseudonym was Crass Falony, because “I am Crass Falony” is an anagram for “Narcissa Malfoy.” We tried to convince ourselves that it sounded like an Italian gangster name, but our friends all told us it was dumb. So we went with The Jonquil instead, because the jonquil flower is a member of the narcissus genus.",
            link: "https://www.youtube.com/embed/YbMtY3EHEU8",
            bonusContent: [

            ]
        },
    ]
    return {episodes};
})();

const view = (() => {
    const content = document.querySelector(".content");

    const createEpisodeSection = (epNum) => {
        const episodeSection = document.createElement("section");
        episodeSection.classList.add("episode-section");
        const episodeNumberLabel = document.createElement("h3");
        episodeNumberLabel.textContent = `~ Episode ${epNum} ~`;
        const episodeTitle = document.createElement("h1");
        episodeTitle.textContent = `"${model.episodes[epNum - 1].title}"`;
        const episodeDesc = document.createElement("p");
        episodeDesc.classList.add("episode-desc");
        episodeDesc.textContent = model.episodes[epNum - 1].desc;
        const episodeVideo = document.createElement("iframe");
        episodeVideo.src = model.episodes[epNum - 1].link;
        episodeVideo.frameBorder = 0;
        episodeVideo.classList.add("episode-video");
        const breakdownHeader = document.createElement("h3");
        breakdownHeader.classList.add("section-sub-head", "about-episode-head");
        breakdownHeader.textContent = "About the episode:";
        const breakdown = document.createElement("p");
        breakdown.textContent = model.episodes[epNum-1].breakdown;

        episodeSection.append(
                episodeNumberLabel,
                episodeTitle,
                episodeDesc,
                episodeVideo,
                breakdownHeader,
                breakdown,
                createBonusContentElements(epNum - 1),
            );
        return episodeSection;
    }
    const createBonusContentElements = (epIndex) => {
        const fragment = document.createDocumentFragment();
        const bonusSectionLabel = document.createElement("h2");
        bonusSectionLabel.textContent = "Bonus Content";
        bonusSectionLabel.classList.add("bonus-section-label");
        fragment.append(bonusSectionLabel);

        if (model.episodes[epIndex].bonusContent.length > 0) {
            model.episodes[epIndex].bonusContent.forEach(bonus => {
                if (!bonus.bonusDesc) {
                    const bonusSubCategoryContainer = document.createElement("div");
                    bonusSubCategoryContainer.classList.add("section-sub-head-container");
                    const createTilde = () => {
                        const tilde = document.createElement("div");
                        tilde.classList.add("tilde");
                        tilde.textContent = "~";
                        return tilde;
                    }
                    const bonusSubCategoryHeader = document.createElement("h3");
                    bonusSubCategoryHeader.classList.add("section-sub-head-text");
                    bonusSubCategoryHeader.textContent = bonus.bonusCategory;
                    bonusSubCategoryContainer.append(createTilde(), bonusSubCategoryHeader, createTilde());
                    fragment.append(bonusSubCategoryContainer);
                } else {
                    const bonusDesc = document.createElement("p");
                    bonusDesc.classList.add("bonus-desc");
                    bonusDesc.textContent = bonus.bonusDesc;
                    fragment.append(bonusDesc);

                    const bonusGridContainer = document.createElement("div");
                    if (bonus.classes) {
                        bonus.classes.forEach(c => bonusGridContainer.classList.add(c));
                    }
                    let bonusItem = "";
                    bonus.links.forEach(link => {
                        if (link.includes("youtube")) {
                            bonusItem = document.createElement("iframe");
                            bonusItem.classList.add("bonus-vid");
                            bonusItem.frameBorder = 0;
                            bonusItem.src = link;
                        } else {
                            bonusItem = document.createElement("img");
                            bonusItem.classList.add("bonus-img");
                            bonusItem.src = link;
                            console.log("it does get here");
                        }
                        bonusItem.classList.add("bonus-item");
                        if (bonus.classes) {
                            bonus.classes.forEach(c => bonusItem.classList.add(`${c}-item`));
                        }
                        bonusGridContainer.append(bonusItem);
                    })
                        fragment.append(bonusGridContainer);

                }
            });
        } else {
            const comingSoon = document.createElement("p");
            comingSoon.classList.add("bonus-desc");
            comingSoon.textContent = "Coming soon!";
            fragment.append(comingSoon);
        }
        return fragment;
    }
    const clearContent = () => {
        if (content) {
            const contentContainer = document.createRange();
            contentContainer.selectNodeContents(content);
            contentContainer.deleteContents();
        }
    }

    const setup = (() => {
        const episodeGrid = document.querySelector(".episode-grid");
    
        const createEpisodeTab = (num) => {
            const tab = document.createElement("div");
            tab.classList.add("ep-tab");
            if (num === 1) {
                tab.classList.add("ep-tab-active");
            }
            tab.dataset.tab = num;
            tab.textContent = num;
            return tab;
        }
        const createEpisodeGrid = (() => {
            for (let i = 1; i <= 7; i++) {
                episodeGrid.append(createEpisodeTab(i));
            }
        })();
        
        content.append(createEpisodeSection(1));
    })();

    const epTabs = document.querySelectorAll(".ep-tab");
    epTabs.forEach(tab => tab.addEventListener("click", (e) => {
        switchEpisodeTab(e);
    }));
    const switchEpisodeTab = (e) => {
        epTabs.forEach(tab => tab.classList.remove("ep-tab-active"));
        e.target.classList.add("ep-tab-active");
        clearContent();
        content.append(createEpisodeSection(e.target.dataset.tab));
        shrinkEpisodeSubHeadingText();
    }
    const shrinkEpisodeSubHeadingText = () => {
        const headings = document.querySelectorAll(".section-sub-head-text");
        let width, height;
        for (let i = 0; i < headings.length; i++) {
            width = headings[i].offsetWidth;
            height = headings[i].offsetHeight;

            for (let w = width; w; w--) {
                headings[i].style.width = w + "px";
                if (headings[i].offsetHeight !== height) {
                    newWidth = w + 1;
                    headings[i].style.width = newWidth + "px";
                    break;
                }
                if (w < headings[i].scrollWidth) {
                    headings[i].style.width = headings[i].scrollWidth + "px";
                } else {
                    headings[i].style.width = (w + 1) + "px";
                }
            }
        }
    }

    return {createEpisodeSection};
})();